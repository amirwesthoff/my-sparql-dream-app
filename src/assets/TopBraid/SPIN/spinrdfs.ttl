# baseURI: http://topbraid.org/spin/spinrdfs
# imports: http://spinrdf.org/spin
# prefix: spinrdfs

@prefix afn: <http://jena.hpl.hp.com/ARQ/function#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix smf: <http://topbraid.org/sparqlmotionfunctions#> .
@prefix sp: <http://spinrdf.org/sp#> .
@prefix spin: <http://spinrdf.org/spin#> .
@prefix spinrdfs: <http://topbraid.org/spin/spinrdfs#> .
@prefix spl: <http://spinrdf.org/spl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

sp:_label
  rdf:type sp:Variable ;
  sp:varName "label" ;
.
sp:_ns
  rdf:type sp:Variable ;
  sp:varName "ns" ;
.
sp:_p
  rdf:type sp:Variable ;
  sp:varName "p" ;
.
sp:_property
  rdf:type sp:Variable ;
  sp:varName "property" ;
.
sp:_range
  rdf:type sp:Variable ;
  sp:varName "range" ;
.
sp:_rdf
  rdf:type sp:Variable ;
  sp:varName "rdf" ;
.
sp:_value
  rdf:type sp:Variable ;
  sp:varName "value" ;
.
<http://topbraid.org/spin/spinrdfs>
  rdf:type owl:Ontology ;
  rdfs:comment "Contains axioms to run constraint checks on a subset of RDF Schema." ;
  owl:imports <http://spinrdf.org/spin> ;
  owl:versionInfo "0.1.1" ;
.
spinrdfs:RangeConstraint
  rdf:type spin:Template ;
  spin:body [
      rdf:type sp:Construct ;
      sp:templates (
          [
            sp:object spin:ConstraintViolation ;
            sp:predicate rdf:type ;
            sp:subject _:b36523 ;
          ]
          [
            sp:object [
                sp:varName "label" ;
              ] ;
            sp:predicate rdfs:label ;
            sp:subject _:b36523 ;
          ]
          [
            sp:object spin:_this ;
            sp:predicate spin:violationRoot ;
            sp:subject _:b36523 ;
          ]
          [
            sp:object [
                sp:varName "property" ;
              ] ;
            sp:predicate spin:violationPath ;
            sp:subject _:b36523 ;
          ]
        ) ;
      sp:where (
          (
            (
              [
                rdf:type sp:Filter ;
                sp:expression [
                    rdf:type sp:and ;
                    sp:arg1 [
                        rdf:type sp:isURI ;
                        sp:arg1 spin:_this ;
                      ] ;
                    sp:arg2 [
                        rdf:type sp:not ;
                        sp:arg1 [
                            rdf:type spinrdfs:isSystem ;
                            sp:arg1 spin:_this ;
                          ] ;
                      ] ;
                  ] ;
              ]
            )
            [
              sp:object [
                  sp:varName "value" ;
                ] ;
              sp:predicate [
                  sp:varName "property" ;
                ] ;
              sp:subject spin:_this ;
            ]
            [
              rdf:type sp:Filter ;
              sp:expression [
                  rdf:type sp:isURI ;
                  sp:arg1 [
                      sp:varName "value" ;
                    ] ;
                ] ;
            ]
          )
          [
            rdf:type sp:TriplePath ;
            sp:object [
                sp:varName "p" ;
              ] ;
            sp:path [
                rdf:type sp:ModPath ;
                sp:modMax -2 ;
                sp:modMin 0 ;
                sp:subPath rdfs:subPropertyOf ;
              ] ;
            sp:subject [
                sp:varName "property" ;
              ] ;
          ]
          [
            sp:object [
                sp:varName "range" ;
              ] ;
            sp:predicate rdfs:range ;
            sp:subject [
                sp:varName "p" ;
              ] ;
          ]
          [
            rdf:type sp:Filter ;
            sp:expression [
                rdf:type sp:ne ;
                sp:arg1 [
                    sp:varName "range" ;
                  ] ;
                sp:arg2 rdfs:Literal ;
              ] ;
          ]
          [
            rdf:type sp:Filter ;
            sp:expression [
                rdf:type sp:and ;
                sp:arg1 [
                    rdf:type spl:hasValue ;
                    sp:arg1 [
                        sp:varName "value" ;
                      ] ;
                    sp:arg2 rdf:type ;
                    sp:arg3 [
                        sp:varName "anyType" ;
                      ] ;
                  ] ;
                sp:arg2 [
                    rdf:type sp:not ;
                    sp:arg1 [
                        rdf:type spl:instanceOf ;
                        sp:arg1 [
                            sp:varName "value" ;
                          ] ;
                        sp:arg2 [
                            sp:varName "range" ;
                          ] ;
                      ] ;
                  ] ;
              ] ;
          ]
          [
            rdf:type sp:Bind ;
            sp:expression [
                rdf:type smf:buildString ;
                sp:arg1 "Range violation: {?range} expected for {?value} at {?property}" ;
              ] ;
            sp:variable [
                sp:varName "label" ;
              ] ;
          ]
        ) ;
    ] ;
  spin:labelTemplate "rdfs:range constraint" ;
  rdfs:comment "Checks whether all property values of ?this have a type compatible with the declared rdfs:ranges on the property, or have no type." ;
  rdfs:label "Range constraint" ;
  rdfs:subClassOf spin:Templates ;
.
spinrdfs:isSystem
  rdf:type spin:Function ;
  spin:body [
      rdf:type sp:Ask ;
      sp:where (
          [
            rdf:type sp:Let ;
            sp:expression [
                rdf:type afn:namespace ;
                sp:arg1 spin:_arg1 ;
              ] ;
            sp:variable sp:_ns ;
          ]
          [
            rdf:type sp:Filter ;
            sp:expression [
                rdf:type sp:or ;
                sp:arg1 [
                    rdf:type sp:or ;
                    sp:arg1 [
                        rdf:type sp:eq ;
                        sp:arg1 sp:_ns ;
                        sp:arg2 [
                            rdf:type xsd:string ;
                            sp:arg1 owl: ;
                          ] ;
                      ] ;
                    sp:arg2 [
                        rdf:type sp:eq ;
                        sp:arg1 sp:_ns ;
                        sp:arg2 [
                            rdf:type xsd:string ;
                            sp:arg1 rdfs: ;
                          ] ;
                      ] ;
                  ] ;
                sp:arg2 [
                    rdf:type sp:eq ;
                    sp:arg1 sp:_ns ;
                    sp:arg2 [
                        rdf:type xsd:string ;
                        sp:arg1 rdf: ;
                      ] ;
                  ] ;
              ] ;
          ]
        ) ;
    ] ;
  spin:constraint [
      rdf:type spl:Argument ;
      spl:predicate sp:arg1 ;
      spl:valueType rdfs:Resource ;
      rdfs:comment "the resource to check" ;
    ] ;
  spin:returnType xsd:boolean ;
  rdfs:comment "Checks whether a given resource (?arg1) is from the RDF, RDFS or OWL namespace." ;
  rdfs:label "is system" ;
  rdfs:subClassOf spin:Functions ;
.
rdfs:Resource
  spin:constraint [
      rdf:type spinrdfs:RangeConstraint ;
    ] ;
.
